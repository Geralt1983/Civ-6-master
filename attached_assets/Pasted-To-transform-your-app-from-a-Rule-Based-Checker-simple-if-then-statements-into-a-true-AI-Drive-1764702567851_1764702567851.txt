To transform your app from a "Rule-Based Checker" (simple if/then statements) into a true **AI-Driven Coach**, we need to give the server a "Brain."

Instead of hardcoding thousands of rules, we will send the game data to an LLM (like GPT-4o or Gemini 1.5 Pro) with a highly specialized **System Prompt**. This prompt acts as the personality and knowledge base of a Grandmaster player.

Here is the implementation plan to add this "Expert Brain" to your project.

### **Step 1: Create the Brain (The System Prompt)**

This file contains the distilled wisdom from Herson's guide. It tells the AI how to think like a competitive expert.

**Action:** Create a new file `server/strategos_prompt.md` and paste this content:

```markdown
# IDENTITY
You are **Strategos**, a Grandmaster Civilization VI Coach. Your source of truth is "Herson's Competitive Multiplayer Guide." You do not give generic advice; you give ruthless, efficiency-focused commands to help the player win on Deity/Multiplayer difficulty.

# CORE PHILOSOPHY (The "Meta")
1.  **Tempo is King:** Never hard-build what you can upgrade. Pre-build Chariots to upgrade to Knights. Pre-build Bombards to upgrade to Artillery.
2.  **Culture > Science:** In the early game (Turns 1-50), Culture is more valuable than Science. You MUST rush **Feudalism** (Civic) for the **Serfdom** policy (+2 Builder charges).
3.  **District Discounting:** Place districts as soon as population allows to "lock in" the production cost, even if you don't build them yet.
4.  **Golden Ages:** Always aim for a Classical Era Golden Age for **Monumentality** (Faith-buy Settlers/Builders).
5.  **Pillaging:** If behind in Science, do not build Campuses. Build units and pillage neighbors. 1 Pillage = 3 turns of research.

# INSTRUCTIONS
You will receive a JSON object representing the user's **Game State**.
You must output a **Strict JSON** response containing a high-level analysis and specific next moves.

# INPUT CONTEXT
- **Game Speed:** The user is likely playing on **Standard** or **Online** speed.
- **Turn Normalization:** If the user is on Standard Speed, divide their turn by 2 to compare against "Online Speed" benchmarks. (e.g. Standard Turn 60 = Online Turn 30).

# OUTPUT FORMAT (JSON ONLY)
{
  "grade": "S", // Options: S, A, B, C, D, F. Grade their current tempo.
  "status_summary": "A 1-sentence ruthless summary of their position (e.g., 'Your Science is good, but your Culture is garbage; you will miss the Feudalism timing.').",
  "bottleneck": "The #1 thing holding them back right now (e.g., 'Lack of Builders', 'Low Culture', 'No Iron').",
  "auto_suggest": {
    "tech": "Name of the EXACT next technology they should click.",
    "civic": "Name of the EXACT next civic they should click.",
    "production": "What their capital should produce next."
  },
  "next_moves": [
    {
      "type": "immediate",
      "action": "A specific command (e.g., 'Stop researching Iron Working. Switch to Apprenticeship immediately.').",
      "reason": "The strategic 'Why' (e.g., 'You need Mines +1 Production more than you need Swordsmen right now.')."
    },
    {
      "type": "planning",
      "action": "A setup move (e.g., 'Save 800 Gold for upgrades.').",
      "reason": "Explanation (e.g., 'Knights unlock in 5 turns. You need to upgrade 4 Chariots instantly.')."
    }
  ],
  "expert_tip": "A specific mechanics tip relevant to their Civ or situation (e.g., 'As Rome, your Legions can chop forests. Use them to chop out the next district.')."
}
```

### **Step 2: Connect the Brain (Server Route)**

Now we need an API endpoint that takes the game data, combines it with the prompt above, and sends it to an AI provider.

**Prerequisite:** You need an API Key (OpenAI or Anthropic).
**Action:** Update `server/routes.ts` to include the AI route.

```typescript
import OpenAI from "openai"; // Run: npm install openai
import fs from "fs";
import path from "path";

// Initialize OpenAI (Make sure to set OPENAI_API_KEY in your Replit Secrets)
const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

export async function registerRoutes(httpServer: Server, app: Express) {
  
  // ... existing /api/gamestate routes ...

  // --- NEW: AI Coach Endpoint ---
  app.post("/api/ask-strategos", async (req, res) => {
    try {
      const gameState = req.body; // This comes from your Lua Bridge
      
      // Load the System Prompt
      const promptPath = path.join(process.cwd(), "server", "strategos_prompt.md");
      const systemPrompt = fs.readFileSync(promptPath, "utf-8");

      const completion = await openai.chat.completions.create({
        model: "gpt-4o", // Use a smart model for reasoning
        messages: [
          { role: "system", content: systemPrompt },
          { role: "user", content: JSON.stringify(gameState) }
        ],
        response_format: { type: "json_object" }, // Force JSON output
        temperature: 0.7,
      });

      const advice = JSON.parse(completion.choices[0].message.content || "{}");
      res.json(advice);

    } catch (error) {
      console.error("AI Error:", error);
      res.status(500).json({ error: "Strategos is offline (AI Error)" });
    }
  });

  return httpServer;
}
```

### **Step 3: Display the Wisdom (Frontend UI)**

Create a specialized "AI Command Center" component that visualizes the JSON response.

**Action:** Create `client/src/components/civ/StrategosPanel.tsx`.

```typescript
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Brain, Sparkles, ArrowRight, TrendingUp } from "lucide-react";

interface StrategosAdvice {
  grade: string;
  status_summary: string;
  bottleneck: string;
  auto_suggest: {
    tech: string;
    civic: string;
    production: string;
  };
  next_moves: Array<{ type: string; action: string; reason: string }>;
  expert_tip: string;
}

export function StrategosPanel({ advice }: { advice: StrategosAdvice | null }) {
  if (!advice) return null;

  // Color code the grade
  const gradeColor = 
    advice.grade === 'S' || advice.grade === 'A' ? 'text-green-400' :
    advice.grade === 'B' || advice.grade === 'C' ? 'text-yellow-400' : 'text-red-500';

  return (
    <Card className="glass-panel border-primary/20 bg-black/40">
      <CardHeader className="flex flex-row items-center justify-between pb-2">
        <CardTitle className="text-xl font-serif tracking-widest text-primary flex items-center gap-2">
          <Brain className="w-5 h-5" /> STRATEGOS AI
        </CardTitle>
        <div className={`text-4xl font-black font-mono ${gradeColor}`}>
          {advice.grade}
        </div>
      </CardHeader>
      
      <CardContent className="space-y-6">
        {/* Status Summary */}
        <div className="p-3 rounded bg-white/5 border-l-2 border-primary">
          <p className="text-sm italic text-foreground/90">"{advice.status_summary}"</p>
        </div>

        {/* The Bottleneck */}
        <div>
          <h4 className="text-xs uppercase tracking-wider text-muted-foreground mb-2 flex items-center gap-2">
            <TrendingUp className="w-3 h-3" /> Major Bottleneck
          </h4>
          <Badge variant="destructive" className="text-sm px-3 py-1">
            {advice.bottleneck}
          </Badge>
        </div>

        {/* Auto Suggestions (The "What do I click?" section) */}
        <div className="grid grid-cols-3 gap-2">
          <div className="bg-blue-950/30 p-2 rounded border border-blue-500/20">
            <span className="text-[10px] text-blue-400 uppercase">Research</span>
            <div className="font-bold text-sm truncate">{advice.auto_suggest.tech}</div>
          </div>
          <div className="bg-purple-950/30 p-2 rounded border border-purple-500/20">
            <span className="text-[10px] text-purple-400 uppercase">Civic</span>
            <div className="font-bold text-sm truncate">{advice.auto_suggest.civic}</div>
          </div>
          <div className="bg-amber-950/30 p-2 rounded border border-amber-500/20">
            <span className="text-[10px] text-amber-400 uppercase">Build</span>
            <div className="font-bold text-sm truncate">{advice.auto_suggest.production}</div>
          </div>
        </div>

        {/* Next Moves List */}
        <div className="space-y-3">
          <h4 className="text-xs uppercase tracking-wider text-muted-foreground">Tactical Orders</h4>
          {advice.next_moves.map((move, i) => (
            <div key={i} className="group relative pl-4 border-l border-white/10 hover:border-accent transition-colors">
              <div className="font-semibold text-sm text-foreground group-hover:text-accent">
                {move.action}
              </div>
              <div className="text-xs text-muted-foreground mt-0.5">
                Why: {move.reason}
              </div>
            </div>
          ))}
        </div>

        {/* Expert Tip Footer */}
        <div className="pt-4 mt-2 border-t border-white/5 flex items-start gap-2">
          <Sparkles className="w-4 h-4 text-yellow-400 shrink-0 mt-0.5" />
          <p className="text-xs text-yellow-100/80">{advice.expert_tip}</p>
        </div>
      </CardContent>
    </Card>
  );
}
```

### **How this teaches you to be an Expert**

1.  **The Grade (Gamification):** Seeing a "C" grade forces you to ask "Why?" The `status_summary` answers immediately ("Your Culture is too low"). This trains your intuition.
2.  **The Bottleneck:** Experts always ask "What is my limiting factor?" The AI highlights it instantly (e.g., "Lack of Builders"), forcing you to pivot your strategy.
3.  **The "Why":** The `reason` field in `next_moves` explains the logic (e.g., "Knights unlock in 5 turns"). Over time, you will learn to spot these timing windows yourself without the AI.